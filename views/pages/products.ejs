<!-- views/pages/index.ejs -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <% include ../partials/head.ejs %>
  </head>

  <body class="container">
    <main>
      <div>
        <h2>PRODUCTS</h2>
        <div class="row mt-4">
          <div class="col-6">
            <table class="table">
              <thead class="thead-light">
                <tr>
                  <th>#</th>
                  <th>Name</th>
                  <th>Link</th>
                  <th>Timeline</th>
                </tr>
              </thead>
              <% products.forEach(function(product,index) { %>
              <tr>
                <td><%= index+1 %></td>
                <td><%= product.name %></td>
                <td>
                  <a href="<%= product.url %>" class="btn btn-primary">buy</a>
                </td>
                <td>
                  <button
                    data-attr-id="<%= product.product_uuid %>"
                    class="btn btn-secondary view-btn"
                  >
                    view
                  </button>
                </td>
              </tr>
              <% }) %>
            </table>
          </div>
          <div class="col-6 d">
            <div class="card">
              <div class="card-body">
                <canvas id="myChart" width="100" height="100"></canvas>
                <div
                  id="spinner"
                  class="spinner-border"
                  style="display: inherit; margin: auto;"
                  role="status"
                >
                  <span class="sr-only">Loading...</span>
                </div>
                <div class="help-txt m-auto" style="display: inline-block;">
                    <span >Select an item from the right</span>
                </div>
                <span class="lowest-price"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </body>
  <script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
  <script>
    $(document).ready(function() {
      $("#spinner").toggle();
      $(".view-btn").click(function() {
        $("#spinner").toggle();
        const productId = $(this).attr("data-attr-id");
        console.log(productId);
        $.ajax({
          url: `https://blue-snow-scraper.herokuapp.com/products/${productId}/timeline`,
          success: function(response) {
            $("#spinner").toggle();
            $(".help-txt").addClass('d-none')
            const data = [];
            const bgColor = [];
            const borderColor = [];
              const labels = response.timeline
              .sort((a, b) => new Date(a.date) - new Date(b.date))
              .map(line => {
                const color = "#000000".replace(/0/g,function(){return (~~(Math.random()*16)).toString(16);});
                borderColor.push(color)
                data.push(Number(line.price.replace(/[^0-9.-]+/g,"")));
                return (new Date(line.date).toLocaleString());                  
              });
            var ctx = document.getElementById("myChart").getContext("2d");
            drawChart(ctx, labels, data);
            $(".lowest-price").text(`Lowest price encountered is ${Math.min(...data)} Rs`)
          }
        });
      });
    });

    function drawChart (ctx, labels, data, borderColor ) {
      var myChart = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels,
                datasets: [
                  {
                    label: "Pricing",
                    data: data,
                    // backgroundColor: bgColor,
                    borderColor,
                    borderWidth: 2
                  }
                ]
              },
              options: {
                scales: {
                  yAxes: [
                    {
                      ticks: {
                        beginAtZero: true
                      }
                    }
                  ]
                }
              }
            });
    }
  </script>
</html>
 -/*